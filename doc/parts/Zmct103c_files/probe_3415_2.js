(function(g,h){"undefined"!==typeof module&&module.exports?module.exports=h():"function"===typeof define&&define.amd?define(h):g.Probe=h.call(g)})(this,function(){function g(a){if(!(this instanceof g))return new g;if(null!==m)return this;m=this;this.config={netWorkTime:!0,serverTime:!0,browserTime:!0,debugIndexTime:3E4,probability:20,dataSize:2E3,pageCollectDelay:200,cookies:null,resourceCollect:null};this._collector=[];this._collectIndex=0;this._Identifiers=(new Date).getTime()+(1+65536*Math.random()|
0).toString(16).substring(1);this.setOptions(a);return this}function h(a,c){this.type=e.PerformanceTiming&&a instanceof PerformanceTiming||!a.entryType?0:1;this.timing=this.__fixedTimeLine(a);this.navigation=c}var m=null,e=this,k=0,n=0;g.prototype={constructor:this,start:function(){if(!e.performance){var a={};a.n=e.location.href;a.s=this._measureScreen();var c=this._getCookies();0<c.length&&(a.x=c);this._post(this._package(a),"forbid");k=1}else if(this.config&&!(100*Math.random()>this.config.probability)){var b=
this,d=0,a=function(){1!==d&&(b._accounting(),d=1)};document.addEventListener?(e.addEventListener("load",function(){setTimeout(function(){0===k&&(b._post(b._package(b.collectPage())),k=1);b._collectResource()},b.config.pageCollectDelay)},!1),e.addEventListener("beforeunload",a,!1),e.addEventListener("unload",a,!1)):(e.attachEvent("onload",function(){setTimeout(function(){0===k&&(b._post(b._package(b.collectPage())),k=1);b._collectResource()},b.config.pageCollectDelay)}),e.attachEvent("onbeforeunload",
a),e.attachEvent("onunload",a))}},_accounting:function(){0===k&&(this._post(this._package(this.collectPage())),k=1);0===n&&(this._scanResourcesOnUnload(),n=1);this._judgeORI(this.collectPage())},_scanResourcesOnUnload:function(){var a=this._targetResources(),c,b,d,e,f=!1;if(a&&a!==this._collector){c=0;for(b=a.length;c<b;c++){f=!1;d=0;for(e=this._collector.length;d<e;d++)if(a[c].n===this._collector[d].n&&a[c].k===this._collector[d].k){f=!0;break}f||this._collector.push(a[c])}this._subConcatSend(this._package(this._collector.slice(this._collectIndex)))}},
_targetResources:function(){var a=null,c=this.config.resourceCollect;return c?a=-1!=="resource,script,img,link".indexOf(c)?this.collectResourceByType(c):this.collectResourceByName(c):a},_collectResource:function(){this.config.resourceCollect&&(this._collector=this._targetResources(),this._subConcatSend(this._package(this._collector)))},_subConcatSend:function(a,c){if(0!==a.length){var b=this.config.dataSize-this._Identifiers.length,d=c||"r";if(a.length>b)if(b=a.substr(0,b).lastIndexOf(","),-1!==b)this._post(a.substr(0,
b),d,!0),this._collectIndex+=a.substr(0,b).split(",").length,this._subConcatSend(a.substr(b+1),c);else throw"too limit dataSize arguments.";a.length<=this.config.dataSize&&(this._collectIndex+=a.split(",").length,this._post(a,d,!0))}},_post:function(a,c,b){if(a){var d=new Image,e="http://mic.pro6e.com/probe/map.gif";!0===b&&(e="http://mic.pro6e.com/probe/mine.gif");d.src=e+"?"+{"default":"arg",forbid:"forbid",debug:"debug"}["r"!==c&&c?c:"default"]+"\x3dp"+this._Identifiers+("forbid"===a?"":a);"complete"===
d.readyState?d=null:d.onload=function(){d=null}}},_package:function(a){var c="";if(!a)return c;if("[object Array]"===Object.prototype.toString.call(a))for(var b=0,d=a.length;b<d;b++)c+=this._package(a[b])+(b<d-1?",":"");else{c+="$";for(b in a)"n"===b?c+=b+encodeURIComponent(a[b].match(/^https?:\/\/(.*?\/.*)\??.*$/)[1])+"$":-1!==a[b]&&(c+=b+a[b]+"$");c=c.substring(0,c.length-1)}return c},_judgeORI:function(a){if(a){var c=[],b;for(b in a)if(!isNaN(a[b])&&(-1>a[b]||a[b]>this.config.debugIndexTime)){a=
new h(e.performance.timing,e.performance.navigation);this._post(a.getOriTime(),"debug");c=this.collectResourceByType("resource");this._subConcatSend(this._package(c),"debug");break}}},setOptions:function(a){a&&(this.config=this._mergerObj([this.config,a]))},collectResourceByName:function(a){if(e.performance&&e.performance.getEntries){var c=[],b=e.performance.getEntriesByType("resource"),d,l,f;if("[object Array]"===Object.prototype.toString.call(a))for(f=0;f<a.length;f++)for(d=0,l=b.length;d<l;d++){if("undefined"!==
typeof a[f]&&a[f]===b[d].name&&-1===b[d].name.indexOf("http://mic.pro6e.com/probe/map.gif")&&-1===b[d].name.indexOf("http://mic.pro6e.com/probe/mine.gif")){c.push(this.collectTime(b[d]));break}}else for(d=0,l=b.length;d<l;d++)if("undefined"!==typeof a&&a===b[d].name&&-1===b[d].name.indexOf("http://mic.pro6e.com/probe/map.gif")&&-1===b[d].name.indexOf("http://mic.pro6e.com/probe/mine.gif")){c.push(this.collectTime(b[d]));break}return c}},collectResourceByType:function(a){if(a&&e.performance&&e.performance.getEntries){for(var c=
[],b=e.performance.getEntriesByType("resource"),d=0,l=b.length;d<l;d++)-1===b[d].name.indexOf("http://mic.pro6e.com/probe/map.gif")&&-1===b[d].name.indexOf("http://mic.pro6e.com/probe/mine.gif")&&("resource"!==a&&a===b[d].initiatorType&&c.push(this.collectTime(b[d])),"resource"===a&&c.push(this.collectTime(b[d])));return c}},collectPage:function(){if(e.performance){var a=this.collectTime(e.performance.timing),c=this._getCookies();0<c.length&&(a.x=c);return a}},collectTime:function(a){if(a){var c=
{},c=this._measureTime(a);a.entryType||(c.s=this._measureScreen());return c}},_getCookies:function(){var a=this.config.cookies,c="";if(a&&a.length)for(var b=0;b<a.length;b++)c+=a[b]+"|"+((RegExp("(?:^|;)\\s*"+a[b]+"\x3d([^;]*)").test(document.cookie)?RegExp.$1:null)||"")+(b===a.length-1?"":",");return c},_mergerObj:function(a){var c={},b,d,e;d=0;for(e=a.length;d<e;d++)for(b in a[d])c[b]=a[d][b];return c},_measureTime:function(a){var c=new h(a,e.performance.navigation),b={},d=this.config;d.netWorkTime&&
(b.a=c.navigationStart(),b.b=c.domainLookupTime(),b.c=c.connectTime());d.serverTime&&(b.d=c.requestReadyTime(),b.e=c.responseTime(),b.f=c.receivedTime());d.browserTime&&(0===c.type?(b.g=c.domParsingTime(),b.h=c.resourcesLoadedTime(),b.i=c.domContentLoadedTime(),b.j=c.firstPaintTime(),b.k=c.loadedTime(),b.l=c.requestCount(),b.m=c.isCache()?0:1,b.o=e.performance.navigation?e.performance.navigation.type:-1,b.n=e.location.href):(b.k=c.loadedTime(),b.m=c.isCache()?0:1,b.n=a.name));return b},_measureScreen:function(){return e.screen.width+
"*"+e.screen.height+"|"+e.screen.availWidth+"*"+e.screen.availHeight}};h.prototype={constructor:this,navigationStart:function(){return 0===this.type?-1:Math.round(this.timing.navigationStart)},domainLookupTime:function(){return this._validate(this.timing.domainLookupEnd-this.timing.domainLookupStart)},connectTime:function(){return this._validate(this.timing.connectEnd-this.timing.connectStart)},requestReadyTime:function(){return this._validate(this.timing.requestStart-this.timing.connectEnd)},responseTime:function(){return 0===
this.timing.requestStart?-1:this._validate(this.timing.responseStart-this.timing.requestStart)},receivedTime:function(){return this.timing.responseEnd===this.timing.navigationStart?0:1E7<this.timing.responseEnd-this.timing.responseStart?-1:this._validate(this.timing.responseEnd-this.timing.responseStart)},domContentLoadedTime:function(){return this.timing.domContentLoadedEventStart?this._validate(this.timing.domContentLoadedEventStart-this.timing.navigationStart):-1},domParsingTime:function(){return this.timing.domContentLoadedEventStart?
this._validate(this.timing.domInteractive-this.timing.domLoading):-1},resourcesLoadedTime:function(){var a=this.timing.domLoading;a>this.timing.requestStart&&(a=this.timing.responseEnd);return this.timing.loadEventStart?this._validate(this.timing.loadEventStart-a):-1},loadedTime:function(){return 0===this.type?this._validate(this.timing.loadEventStart-this.timing.navigationStart):Math.round(this.timing.duration)},firstPaintTime:function(){var a=e.performance.timing.msFirstPaint;"undefined"!==typeof chrome&&
chrome.loadTimes&&chrome.loadTimes()&&(a=1E3*chrome.loadTimes().firstPaintTime);return a?this._validate(a-this.timing.navigationStart):-1},requestCount:function(){return e.performance.getEntries?e.performance.getEntriesByType("resource").length:-1},isCache:function(){if(0===this.type){if(this.navigation&&1===this.navigation.type)return!1;if(0===this.timing.requestStart||this.timing.connectStart===this.timing.connectEnd)return!0}else if(this.timing.fetchStart===this.timing.responseEnd)return!0;return!1},
_validate:function(a){return 0>a?-1:Math.round(a)},getOriTime:function(){return window.JSON?JSON.stringify(this.timing):"err : JSON object can't get!"},__fixedTimeLine:function(a){var c={};if(!a)return c;var b="navigationStart redirectStart unloadEventStart unloadEventEnd redirectEnd fetchStart domainLookupStart domainLookupEnd connectStart secureConnectionStart connectEnd requestStart responseStart responseEnd domLoading domInteractive domContentLoadedEventStart domContentLoadedEventEnd domComplete loadEventStart loadEventEnd".split(" "),
d;1===this.type&&(b=b.slice(0,14),b.splice(2,2),b=b.concat(["duration","entryType","initiatorType","name"]));for(var e=0;e<b.length;e++)d=b[e],c[d]=1===this.type&&"navigationStart"===d?a.startTime:a[d];return c}};return g});